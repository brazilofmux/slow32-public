# SLOW32 Backend Status

## Current Status (2025-09-08)

### Major Accomplishments

#### Standard Library Complete Reorganization
- **Created libc.s32a** (22,792 bytes) - Professional standard C library:
  - Complete string.h implementation (strlen, strcpy, strcat, strcmp, strstr, strtok, etc.)
  - Full stdio.h support (printf with varargs, puts, getchar, file operations)
  - Dynamic memory (malloc, free, calloc, realloc with proper heap management)
  - Extended stdlib.h (atoi, strtoul, itoa, qsort, rand/srand, exit/abort)
  - Complete ctype.h (all character classification and conversion)
  - Memory operations (memcpy, memmove, memset, memchr, memrchr)
- **Created libs32.s32a** (5,428 bytes) - Compiler runtime support:
  - 64-bit arithmetic (__udivdi3, __divdi3, __moddi3, __umoddi3)
  - Shift operations (__ashldi3, __lshrdi3, __ashrdi3)
  - Division helpers (__udivsi3, __umodsi3)
  - LLVM intrinsics support
- **Added runtime/include/limits.h** - SLOW32-specific system limits
- **New functions implemented**:
  - strtoul() - String to unsigned long with base support
  - itoa/utoa/ltoa/ultoa() - Integer to string conversions
  - memrchr() - Reverse memory search

#### Critical LLVM Backend Fix
- **Fixed optimizer bug** - Function arguments preserved at -O1 and above
- JAL_CALL/JALR_CALL now properly mark R3-R10 as implicit uses
- Prevents Machine CSE from eliminating argument setup code

## Previous Status (2025-09-03)

### Test Results - Regression Test Suite
- **Total Tests**: 13
- **Passing**: 6  
- **Failing**: 2 (bug005-getelementptr, feature-loops)
- **Skipped**: 5 (no test.c files)

### Test Results - Original Regression Tests
- **Total Tests**: 13
- **Passing**: 6
- **Failing**: 2
- **Skipped**: 5

### Passing Tests (Comprehensive Suite)
- test_arithmetic ✓ - Basic arithmetic operations (ADD, SUB, MUL, DIV, REM)
- test_shifts ✓ - Shift operations (SLL, SRL, SRA) with immediate and register operands
- test_branches ✓ - All branch instructions and comparisons
- test_edge_cases ✓ - Boundary conditions, overflow, underflow
- test_immediate_patterns ✓ - Immediate value handling
- test_globals ✓ - Global variables and arrays (fixed %hi/%lo ordering in linker)

### Failing Tests (Comprehensive Suite)
- test_function_calls - Recursive factorial returning wrong value
- test_varargs - Security violation on write to protected memory
- test_stack_stress - Fibonacci calculation issues

### Passing Tests (Original Regression)
- bug001-varargs-clobbered ✓
- bug003-static-vars ✓
- bug004-phi-loops ✓
- feature-arithmetic ✓
- feature-function-calls ✓
- feature-shifts ✓

### Failing Tests
1. **bug005-getelementptr** - Memcpy inline expansion register reuse bug
   - Issue: When expanding small memcpy operations, the backend incorrectly reuses the base address register
   - Result: Garbage output instead of "ABC\n"

2. **feature-loops** - Character generation produces wrong ASCII values
   - Issue: Simple addition (48 + i) generates complex shift-and-add sequence that produces wrong results
   - Logic is correct (loops work), but outputs raw bytes 0x00-0x08 instead of '0'-'8'

### Recent Improvements (2025-09-03 - Latest Session with ChatGPT 5 Recommendations)
- **Implemented getOptimalMemOpType()** - Tells LLVM to prefer i32 operations for memcpy/memset
- **Added isLegalAddressingMode()** - Guides LLVM's address folding decisions for [base+imm16]
- **Fixed CALLSEQ_START/END usage** - Replaced manual SP adjustment with proper call sequence nodes
- **Added callseq patterns** - TableGen patterns for callseq_start/end prevent selection crashes
- **Added offset load/store patterns** - Proper base+offset addressing for getelementptr operations
- **Added commutative immediate patterns** - Handles (imm op reg) and (reg op imm) correctly
- **Added sign extension patterns** - Explicit patterns for i8/i16 to i32 sign extension
- **Increased memcpy expansion limits** - Now handles up to 4 stores (16 bytes) efficiently
- **Added immediate constraints (simm16/uimm16)** - Prevents invalid instructions with out-of-range immediates
- **Fixed constant materialization** - Large constants now properly use LUI for upper 16 bits
- **Fixed regression test configuration** - Corrected path to debug_char.s32o runtime library

### Previous Improvements (2025-09-03)
- **Fixed basic block label generation** - Branch targets now emit as proper labels instead of comments
- **Fixed .long to .word directive** - Backend now emits .word for 32-bit data (assembler compatible)
- **Added %hi/%lo markers** - Global addresses now emit with proper relocation markers
- **Modified linker to accept flexible %hi/%lo ordering** - Linker now accepts LUI/ORI in either order
- Built SLOW32-aware clang from clean /ztank path (no symbolic links)
- Created comprehensive test suite with 9 tests covering all major features
- Achieved 67% pass rate on new test suite (6/9 passing)

### Previous Improvements
- Fixed clang SLOW32 target with proper data layout alignment
- Fixed stack frame epilogue (now uses SP-relative addressing)
- Added SLOW32 to Triple.cpp for architecture recognition
- Fixed varargs support with proper char* va_list
- Cleaned up duplicate comparison patterns
- Added immediate comparison patterns

### Known Issues
1. **Recursive Functions**: Factorial and Fibonacci producing incorrect results (likely stack frame issue)
2. **Varargs Implementation**: Security violation - writing to protected memory
3. **i8 Arithmetic with signext**: Operations on i8 with sign extension generate inefficient shift sequences
4. **Memcpy Register Allocation**: Byte-wise memcpy expansion can clobber base address register
5. **Compiler Warnings**: Unused variables in SLOW32ISelLowering.cpp

### Next Steps
1. Debug recursive function call issues (stack frame or register preservation)
2. Fix varargs memory protection violation
3. Fix character generation pattern to produce correct ASCII values
4. Investigate and fix memcpy expansion register allocation
5. Clean up compiler warnings

### Working Features
- ✅ Basic arithmetic (ADD, SUB, MUL, DIV, REM)
- ✅ Shift operations (SLL, SRL, SRA)
- ✅ Branch instructions (BEQ, BNE, BLT, BGE)
- ✅ Comparisons (all comparison operations)
- ✅ Simple function calls
- ✅ Stack frame management (prologue/epilogue)
- ✅ Immediate value handling
- ✅ Basic block labels (fixed in this session)