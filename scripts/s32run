#!/bin/bash
# SLOW-32 Emulator Runner
# Usage: s32run [options] program.s32x [args...]

EMULATOR="slow32-dbt"
DEBUG_OPTS=""
PROGRAM=""
PROGRAM_ARGS=()

function show_help() {
    echo "SLOW-32 Emulator Runner"
    echo "Usage: s32run [options] program.s32x [args...]"
    echo ""
    echo "Emulator Selection (default: slow32-dbt):"
    echo "  -f, --fast        Use optimized C++ emulator (slow32-fast)"
    echo "  -d, --dbt         Use dynamic binary translator (slow32-dbt) [default]"
    echo "  -i, --interp      Use C++ interpreter (slow32)"
    echo "  -q, --qemu        Use QEMU TCG emulator (qemu-system-slow32)"
    echo ""
    echo "Debug Options (slow32 and slow32-dbt only - not supported by slow32-fast or qemu):"
    echo "  -s, --step        Step through each instruction"
    echo "  -t, --trace       Trace every instruction"
    echo "  -r, --registers   Show register changes"
    echo "  -c N, --cycles N  Limit execution to N cycles"
    echo "  -b ADDR           Set breakpoint at address"
    echo "  -w RANGE          Watch memory range (e.g., 0x1000-0x2000)"
    echo ""
    echo "Other:"
    echo "  -h, --help        Show this help"
    echo ""
    echo "Notes:"
    echo "  - Program arguments are passed after the program name"
    echo "  - For QEMU, arguments are passed via -append"
    echo "  - Debug options are supported by slow32 and slow32-dbt, not slow32-fast or qemu"
    exit 0
}

while [[ $# -gt 0 ]]; do
    case $1 in
        -f|--fast)
            EMULATOR="slow32-fast"
            shift
            ;;
        -d|--dbt)
            EMULATOR="slow32-dbt"
            shift
            ;;
        -i|--interp)
            EMULATOR="slow32"
            shift
            ;;
        -q|--qemu)
            EMULATOR="qemu-system-slow32"
            shift
            ;;
        -s|--step)
            DEBUG_OPTS="$DEBUG_OPTS -s"
            shift
            ;;
        -t|--trace)
            DEBUG_OPTS="$DEBUG_OPTS -t"
            shift
            ;;
        -r|--registers)
            DEBUG_OPTS="$DEBUG_OPTS -r"
            shift
            ;;
        -c|--cycles)
            DEBUG_OPTS="$DEBUG_OPTS -c $2"
            shift 2
            ;;
        -b)
            DEBUG_OPTS="$DEBUG_OPTS -b $2"
            shift 2
            ;;
        -w)
            DEBUG_OPTS="$DEBUG_OPTS -w $2"
            shift 2
            ;;
        -h|--help)
            show_help
            ;;
        *.s32x)
            PROGRAM="$1"
            shift
            # Collect remaining arguments as program arguments
            PROGRAM_ARGS=("$@")
            break
            ;;
        *)
            echo "Unknown option: $1"
            show_help
            ;;
    esac
done

if [ -z "$PROGRAM" ]; then
    echo "Error: No program specified"
    show_help
fi

if [ ! -f "$PROGRAM" ]; then
    echo "Error: Program file not found: $PROGRAM"
    exit 1
fi

# Warn if debug options used with emulators that don't support them
if [ -n "$DEBUG_OPTS" ] && [ "$EMULATOR" != "slow32" ] && [ "$EMULATOR" != "slow32-dbt" ]; then
    echo "Warning: Debug options are only supported by slow32 and slow32-dbt, ignoring: $DEBUG_OPTS"
    DEBUG_OPTS=""
fi

echo "=== Running $PROGRAM with $EMULATOR ==="
if [ "$EMULATOR" = "qemu-system-slow32" ]; then
    # QEMU uses -append for program arguments
    if [ ${#PROGRAM_ARGS[@]} -gt 0 ]; then
        # Build append string from program arguments (QEMU already sets argv[0] to the kernel filename)
        APPEND_STR=""
        for arg in "${PROGRAM_ARGS[@]}"; do
            if [ -z "$APPEND_STR" ]; then
                APPEND_STR="$arg"
            else
                APPEND_STR="$APPEND_STR $arg"
            fi
        done
        exec $EMULATOR -machine slow32-tcg -kernel "$PROGRAM" -nographic -append "$APPEND_STR"
    else
        exec $EMULATOR -machine slow32-tcg -kernel "$PROGRAM" -nographic
    fi
elif [ "$EMULATOR" = "slow32-fast" ]; then
    # slow32-fast doesn't support debug options, just program and args
    exec $EMULATOR "$PROGRAM" "${PROGRAM_ARGS[@]}"
elif [ "$EMULATOR" = "slow32-dbt" ]; then
    # slow32-dbt: Stage 4 is the default
    exec $EMULATOR $DEBUG_OPTS "$PROGRAM" "${PROGRAM_ARGS[@]}"
else
    # slow32 supports debug options
    exec $EMULATOR $DEBUG_OPTS "$PROGRAM" "${PROGRAM_ARGS[@]}"
fi
